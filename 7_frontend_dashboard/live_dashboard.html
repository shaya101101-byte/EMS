<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Live Dashboard - AquaSafe AI</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    /* Small page-specific styles to keep the look clean */
    .dashboard-container { max-width: 1100px; margin: 32px auto; padding: 0 16px; }
    .cards { display: grid; grid-template-columns: repeat(auto-fit,minmax(160px,1fr)); gap: 16px; margin-bottom: 24px; }
    .card { background: #fff; border-radius: 8px; padding: 16px; box-shadow: 0 6px 18px rgba(20,20,40,0.04); }
    .card h4 { margin: 0 0 8px 0; font-size: 13px; color:#666; }
    .card .value { font-size: 22px; font-weight:700; color:#1f6feb; }
    .controls { display:flex; gap:12px; align-items:center; margin-bottom:16px; }
    .chart-wrap { background:#fff; padding:16px; border-radius:8px; box-shadow:0 6px 18px rgba(20,20,40,0.04); }
    header.local-nav { background: #f6f0fb; padding: 12px 24px; border-bottom:1px solid #eee; }
    header.local-nav .nav-links { display:flex; gap:12px; align-items:center; }
    .btn { padding:8px 12px; background:#1976d2; color:white; border-radius:6px; text-decoration:none; display:inline-block }
    .btn.secondary { background:#e0e0e0; color:#222 }
  </style>
</head>
<body>
  <header class="local-nav">
    <div style="max-width:1100px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;">
      <div><a href="index.html" style="text-decoration:none;color:#1976d2;font-weight:700">AquaSafe AI</a></div>
      <nav class="nav-links">
        <a href="index.html">Home</a>
        <a href="upload.html">Upload</a>
        <a href="analytics.html">Analytics</a>
        <a href="history.html">History</a>
      </nav>
    </div>
  </header>

  <main class="dashboard-container">
    <h2>Live Dashboard</h2>
    <p style="color:#555;margin-top:4px;margin-bottom:20px">Real-time microscope/webcam feed. Select input source and click Start Feed to begin.</p>

    <!-- Modern Live Feed Section -->
    <div id="videoContainer">
      <video id="liveVideoFeed" playsinline autoplay muted></video>
      <div id="videoPlaceholder">Click "Start Feed" to begin streaming</div>
    </div>

    <!-- Feed Controls -->
    <div class="feed-controls">
      <div class="control-group">
        <label>Input Source</label>
        <select id="sourceToggle">
          <option value="webcam">Webcam</option>
          <option value="microscope">USB Microscope</option>
        </select>
      </div>

        <div class="control-group">
        <label>&nbsp;</label>
        <div class="feed-buttons">
          <button id="startFeedBtn" class="feed-btn start">Start Feed</button>
          <button id="stopFeedBtn" class="feed-btn stop" disabled>Stop Feed</button>
          <button id="captureSnapshotBtn" class="feed-btn capture-btn" disabled>Capture Snapshot</button>
          <button id="analyzeBtn" class="feed-btn" style="display:none; background:#28a745">Analyze</button>
          <button id="downloadReportBtn" class="feed-btn" style="display:none; background:#17a2b8">Download Report</button>
        </div>
      </div>

      <div class="fps-indicator">
        <div class="label">FPS</div>
        <div id="fpsValue" class="value">0 FPS</div>
      </div>
    </div>

    <!-- Analysis Result Display -->
    <div id="analysisResult" style="margin-top:20px; display:none; background:#f9f9f9; padding:16px; border-radius:8px; border-left:4px solid #1f6feb;"></div>

    <!-- Legacy sensor cards (preserved) -->
    <div class="controls" style="display:none;">
      <button id="refreshBtn" class="btn">Refresh Data</button>
      <button id="autoRefreshBtn" class="btn secondary">Start Auto-Refresh</button>
      <div style="margin-left:auto;color:#666">Showing last 24 hours (Turbidity)</div>
    </div>

    <div class="cards" style="display:none;">
      <div class="card"><h4>Turbidity (NTU)</h4><div id="turbidityValue" class="value">--</div></div>
      <div class="card"><h4>pH</h4><div id="phValue" class="value">--</div></div>
      <div class="card"><h4>Temperature (¬∞C)</h4><div id="tempValue" class="value">--</div></div>
      <div class="card"><h4>Dissolved Oxygen (mg/L)</h4><div id="doValue" class="value">--</div></div>
      <div class="card"><h4>TDS (ppm)</h4><div id="tdsValue" class="value">--</div></div>
      <div class="card"><h4>Conductivity (¬µS/cm)</h4><div id="condValue" class="value">--</div></div>
    </div>

    <div class="chart-wrap" style="display:none;">
      <canvas id="turbidityChart" height="120"></canvas>
    </div>

  </main>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="js/live_dashboard.js"></script>
  <link rel="stylesheet" href="css/live_dashboard.css">
  <script src="js/live_dashboard_feed.js"></script>
  <div id="snapshotToast" class="snapshot-toast" aria-live="polite" hidden></div>

  <!-- LIVE MODEL DETECTION SCRIPT -->
  <script>
    let lastUploadedImageId = null;
    const video = document.getElementById("liveVideoFeed");
    const analyzeBtn = document.getElementById("analyzeBtn");
    const downloadReportBtn = document.getElementById("downloadReportBtn");

    // ========================================
    // CAPTURE SNAPSHOT & UPLOAD
    // ========================================
    function captureSnapshot() {
      // Check if video is playing
      if (!video.srcObject || video.paused || video.ended) {
        alert("‚ùå Video not playing. Click 'Start Feed' first.");
        return;
      }

      // Check if video has valid dimensions
      if (video.videoWidth === 0 || video.videoHeight === 0) {
        alert("‚ùå Video not ready. Wait for the feed to load.");
        return;
      }

      const canvas = document.createElement("canvas");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext("2d");
      if (!ctx) {
        alert("‚ùå Canvas context failed");
        return;
      }
      ctx.drawImage(video, 0, 0);

      canvas.toBlob((blob) => {
        if (!blob) {
          alert("‚ùå Canvas blob conversion failed");
          return;
        }
        const formData = new FormData();
        formData.append("image", blob, "snapshot.jpg");

        fetch("http://127.0.0.1:8000/api/upload-snapshot/", {
          method: "POST",
          body: formData
        })
        .then(res => {
          if (!res.ok) {
            console.error("Upload response error:", res.status, res.statusText);
            throw new Error(`Server error: ${res.status}`);
          }
          return res.json();
        })
        .then(data => {
          if (data.id) {
            lastUploadedImageId = data.id;
            analyzeBtn.style.display = "inline-block";
            alert("‚úÖ Snapshot Uploaded! Click 'Analyze' to run YOLO detection.");
          } else {
            alert("‚ùå Upload Failed: " + (data.error || data.detail || "Unknown error"));
          }
        })
        .catch(err => {
          console.error("Upload error:", err);
          alert("‚ùå Upload failed: " + err.message);
        });
      }, "image/jpeg", 0.95);
    }

    // Override the capture snapshot button
    document.getElementById("captureSnapshotBtn").addEventListener("click", captureSnapshot);

    // ========================================
    // ANALYZE SNAPSHOT (YOLO MODEL)
    // ========================================
    analyzeBtn.addEventListener("click", () => {
      if (!lastUploadedImageId) {
        alert("‚ùå No snapshot uploaded yet. Click 'Capture Snapshot' first.");
        return;
      }

      analyzeBtn.disabled = true;
      analyzeBtn.textContent = "Analyzing...";

      fetch(`http://127.0.0.1:8000/api/analyze/${lastUploadedImageId}/`)
        .then(res => {
          if (!res.ok) {
            console.error("Analysis response error:", res.status, res.statusText);
            throw new Error(`Server error: ${res.status}`);
          }
          return res.json();
        })
        .then(data => {
          if (!data) {
            throw new Error("Empty response from server");
          }

          const safeColor = data.safe ? "#28a745" : "#dc3545";
          const safeText = data.safe ? "‚úÖ Safe" : "‚ö†Ô∏è Unsafe";

          let html = `
            <h3 style="margin-top:0; color:#1f6feb">üìä Analysis Result</h3>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
              <div>
                <p><b>ü¶† Species:</b> ${data.species || "Unknown"}</p>
                <p><b>üìù Description:</b> ${data.meaning || "No description"}</p>
                <p><b>üî¢ Count:</b> ${data.count || 0} organisms</p>
                <p><b>üìä Confidence:</b> ${((data.confidence || 0) * 100).toFixed(1)}%</p>
                <p><b>Status:</b> <span style="color:${safeColor}; font-weight:600; font-size:16px">${safeText}</span></p>
              </div>
              <div>
                ${data.annotated_image ? `<img src="${data.annotated_image}" width="300" style="border-radius:8px; border:2px solid #ddd;">` : "<p>No annotated image</p>"}
              </div>
            </div>
          `;
          document.getElementById("analysisResult").innerHTML = html;
          document.getElementById("analysisResult").style.display = "block";
          downloadReportBtn.style.display = "inline-block";
        })
        .catch(err => {
          console.error("Analysis error:", err);
          alert("‚ùå Analysis failed: " + err.message);
        })
        .finally(() => {
          analyzeBtn.disabled = false;
          analyzeBtn.textContent = "Analyze";
        });
    });
                <p><b>üî¢ Count:</b> ${data.count || 0}</p>
                <p><b>Status:</b> <span style="color:${safeColor}; font-weight:600; font-size:16px">${safeText}</span></p>
              </div>
              <div>
                ${data.annotated_image ? `<img src="${data.annotated_image}" width="300" style="border-radius:8px; border:2px solid #ddd;">` : "<p>No annotated image</p>"}
              </div>
            </div>
          `;
          document.getElementById("analysisResult").innerHTML = html;
          document.getElementById("analysisResult").style.display = "block";
          downloadReportBtn.style.display = "inline-block";
        })
        .catch(err => {
          console.error("Analysis error:", err);
          alert("‚ùå Analysis failed: " + err.message);
        })
        .finally(() => {
          analyzeBtn.disabled = false;
          analyzeBtn.textContent = "Analyze";
        });
    });

    // ========================================
    // PDF DOWNLOAD
    // ========================================
    downloadReportBtn.addEventListener("click", () => {
      if (!lastUploadedImageId) {
        alert("‚ùå No analysis to download");
        return;
      }
      window.open(`http://127.0.0.1:8000/api/download-report/${lastUploadedImageId}/`, "_blank");
    });
  </script>
</body>
</html>