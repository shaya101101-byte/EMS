<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Image</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>

    <!-- NAVBAR -->
    <header class="navbar">
        <div class="nav-left">
            <img src="assets1/logo.jpeg" alt="logo" width="100" height="100">
            <span class="logo-text">AquaSafe AI</span>
        </div>

        <nav class="nav-links">
            <a href="index.html">Home</a>
            <a href="upload.html" class="active">Upload</a>
            <a href="history.html">History</a>
            <a href="analytics.html">Analytics</a>
            <a href="about.html">About</a>
        </nav>
    </header>

    <!-- MAIN CONTENT -->
    <section class="upload-section">
        <div class="upload-box">
            <h2>Upload Microscopic Image</h2>
            <p>Upload your water sample image to analyze organisms and water quality.</p>

            <input type="file" id="imageInput" accept="image/*">
            <br><br>

            <img id="previewImage" style="max-width: 400px; display:none; border-radius: 10px;">
            <br><br>

            <button id="analyzeBtn" style="display:none;" class="btn primary">Analyze</button>
        </div>
    </section>

    <!-- Processing modal markup -->
    <div id="processingModal">
      <div class="modal-card">
        <div class="title">Processing Image</div>
        <div class="phase">Preparingâ€¦</div>
        <div class="progress-ring">
          <svg width="120" height="120">
            <circle class="bg" cx="60" cy="60" r="48"></circle>
            <circle class="fg" cx="60" cy="60" r="48"></circle>
          </svg>
          <div class="progress-percent">0%</div>
        </div>
        <div class="phase-steps">
          <div class="step">Uploading</div>
          <div class="step">Segmenting</div>
          <div class="step">Classifying</div>
          <div class="step">Done</div>
        </div>
      </div>
    </div>

    <link rel="stylesheet" href="processingModal.css">
    <script src="processingModal.js"></script>

    <script>
    // Preserve original behavior but wrap with processing modal
    const input = document.getElementById("imageInput");
    const preview = document.getElementById("previewImage");
    const analyzeBtn = document.getElementById("analyzeBtn");

    input.addEventListener("change", () => {
        const file = input.files[0];
        if (!file) return;
        preview.src = URL.createObjectURL(file);
        preview.style.display = "block";
        analyzeBtn.style.display = "inline-block";
    });

    // Extracted original handler into a function so we can wrap it
    async function originalAnalyzeHandler(){
        const file = input.files[0];
        if (!file) return alert("Please select an image!");

        const formData = new FormData();
        formData.append("file", file);
        formData.append("image", file);

        try {
            const res = await fetch("http://127.0.0.1:8000/predict", {
                method: "POST",
                body: formData
            });

            const data = await res.json();
            localStorage.setItem("analysisResults", JSON.stringify(data));

            try {
                const transformed = (function(predictResponse){
                    let counts = {};
                    if (predictResponse.species && Array.isArray(predictResponse.species)){
                        predictResponse.species.forEach(sp => { counts[sp.name] = sp.count; });
                    } else if (predictResponse.counts){
                        counts = predictResponse.counts;
                    }
                    const perClass = Object.entries(counts).map(([name,count])=>({class_name:name,count:count,percentage: predictResponse.total_count>0?((count/predictResponse.total_count)*100).toFixed(1):0}));
                    let verdict = 'Safe', reason = 'No harmful organisms detected.';
                    const unsafeClasses = ['rotifer']; const cautionClasses = ['algae'];
                    for (let cname in counts){ if (unsafeClasses.includes(cname.toLowerCase())){ verdict='Unsafe'; reason=`High-risk organism(s) detected: ${cname}. Immediate action recommended.`; break;} else if (cautionClasses.includes(cname.toLowerCase())){ if (verdict!=='Unsafe'){ verdict='Caution'; reason=`Presence of ${cname} detected. Review recommended.`; } } }
                    return {
                        total_detections: predictResponse.total_count||0,
                        per_class: perClass,
                        overall_verdict:{verdict:verdict,reason:reason},
                        annotated_image_url: predictResponse.annotated_image_url||'',
                        timestamp: predictResponse.timestamp||new Date().toISOString(),
                        analysis_id: predictResponse.analysis_id||predictResponse.id||0,
                        total_count: predictResponse.total_count||0,
                        species: predictResponse.species||[],
                        counts: counts,
                        detections: predictResponse.detections||[],
                        uploaded_image_url: predictResponse.uploaded_image_url||''
                    };
                })(data);
                localStorage.setItem('currentAnalysis', JSON.stringify(transformed));
            } catch(e){
                console.warn('Transform failed', e);
            }

            // navigate to analytics (same behavior as before)
            window.location.href = 'analytics.html';
        } catch (err){
            alert('Upload failed: '+err.message);
        }
    }

    // New wrapper: show modal first, run original handler, then hide modal
    analyzeBtn.addEventListener("click", async () => {
        try{
            if (typeof showProcessingModal === 'function') showProcessingModal();
        } catch(e){}
        try{
            await originalAnalyzeHandler();
        } finally {
            try{ if (typeof hideProcessingModal === 'function') hideProcessingModal(); } catch(e){}
        }
    });
    </script>

</body>
</html>