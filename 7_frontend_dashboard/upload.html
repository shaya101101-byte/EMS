<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Image</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="assets/css/upload.css">
    <style>
        /* Page-local UI enhancements (offline, upload-only) */
        body { background: linear-gradient(to bottom right, #dfe9f3, #ffffff); }
        .upload-section { display:flex; align-items:center; justify-content:center; padding:48px 16px; }
        .upload-box {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.12);
            border-radius: 20px;
            padding: 48px;
            width: 100%;
            max-width: 520px;
            text-align: center;
            margin: 12px;
        }

        .upload-box h2 { margin: 6px 0 8px; color: #083b75; font-size: 20px; }
        .upload-box p { margin: 0 0 18px; color:#34526a; font-size:14px; }

        /* File preview tweaks */
        #previewImage { max-width: 100%; display: none; border-radius: 10px; margin-top: 14px; }

        /* Custom file chooser button - visually wraps the original input (input keeps same id)
           The input remains accessible to existing JS via `#imageInput` */
        .file-chooser { margin: 8px 0; }
        .choose-btn {
            display: inline-block;
            background: #eef3ff;
            color: #0b3b75;
            padding: 12px 18px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid rgba(11,75,160,0.06);
            box-shadow: 0 6px 18px rgba(11,75,160,0.04);
            font-size: 15px;
        }
        .choose-btn input[type="file"] {
            position: absolute !important;
            left: -9999px !important;
            width: 1px !important;
            height: 1px !important;
            overflow: hidden !important;
            opacity: 0 !important;
        }

        /* Analyze / Upload button styles (keep id/class intact) */
        #analyzeBtn {
            background: linear-gradient(to right, #007bff, #00d4ff);
            color: white;
            font-weight: 600;
            padding: 12px 25px;
            border-radius: 8px;
            border: none;
            transition: transform .3s ease, box-shadow .3s ease, opacity .2s ease;
            cursor: pointer;
            display: none;
        }
        #analyzeBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 122, 255, 0.3);
        }

        /* Drag-and-drop visual zone (non-functional visual only to preserve existing JS) */
        .drop-zone {
            margin-top: 22px;
            padding: 30px 22px;
            border-radius: 12px;
            border: 2px dashed rgba(50,70,90,0.12);
            background: rgba(255,255,255,0.6);
            color: #264656;
            font-size: 15px;
            box-shadow: 0 8px 22px rgba(20,40,80,0.04);
        }

        .supported { margin-top:10px; font-size:12px; color:#55656f; }

        @media (max-width:520px){ .upload-box { padding: 28px; border-radius:14px; max-width: 92%; } }
    </style>
</head>
<body>

    <!-- NAVBAR -->
    <header class="navbar">
        <div class="nav-left">
            <img src="assets1/logo.jpeg" alt="logo" width="100" height="100">
            <span class="logo-text">AquaSafe AI</span>
        </div>

        <nav class="nav-links">
            <a href="index.html">Home</a>
            <a href="upload.html" class="active">Upload</a>
            <a href="history.html">History</a>
            <a href="analytics.html">Analytics</a>
            <a href="about.html">About</a>
        </nav>
    </header>

    <!-- MAIN CONTENT -->
    <section class="upload-section">
        <div class="upload-box upload-card">
            <h2 class="upload-title">ðŸ”¬ Upload Microscopic Image</h2>
            <p class="upload-description">Upload your water sample image to analyze organisms and water quality.</p>

            <!-- keep original file input and IDs untouched; wrap visually in styled button -->
            <div class="file-chooser">
                <label class="choose-btn upload-btn">Choose File
                    <input type="file" id="imageInput" accept="image/*">
                </label>
            </div>

            <img id="previewImage" style="max-width: 400px; display:none; border-radius: 10px;">

            <div style="margin-top:16px;">
                <button id="analyzeBtn" class="btn primary upload-btn">Analyze</button>
            </div>

            <!-- Visual drag-and-drop zone (decorative only - does not modify JS behavior) -->
            <div class="drop-zone" aria-hidden="true">
                Drag &amp; drop an image here (or use the file chooser above)
            </div>

            <div class="supported">Supported formats: JPG, PNG, TIFF</div>
        </div>
    </section>

    <!-- Processing modal markup -->
    <div id="processingModal">
      <div class="modal-card">
        <div class="title">Processing Image</div>
        <div class="phase">Preparingâ€¦</div>
        <div class="progress-ring">
          <svg width="120" height="120">
            <circle class="bg" cx="60" cy="60" r="48"></circle>
            <circle class="fg" cx="60" cy="60" r="48"></circle>
          </svg>
          <div class="progress-percent">0%</div>
        </div>
        <div class="phase-steps">
          <div class="step">Uploading</div>
          <div class="step">Segmenting</div>
          <div class="step">Classifying</div>
          <div class="step">Done</div>
        </div>
      </div>
    </div>

    <link rel="stylesheet" href="processingModal.css">
    <script src="processingModal.js"></script>

    <script>
    // Preserve original behavior but wrap with processing modal
    const input = document.getElementById("imageInput");
    const preview = document.getElementById("previewImage");
    const analyzeBtn = document.getElementById("analyzeBtn");

    input.addEventListener("change", () => {
        const file = input.files[0];
        if (!file) return;
        preview.src = URL.createObjectURL(file);
        preview.style.display = "block";
        analyzeBtn.style.display = "inline-block";
    });

    // Extracted original handler into a function so we can wrap it
    async function originalAnalyzeHandler(){
        const file = input.files[0];
        if (!file) return alert("Please select an image!");

        const formData = new FormData();
        formData.append("file", file);
        formData.append("image", file);

        try {
            const res = await fetch("http://127.0.0.1:8000/predict", {
                method: "POST",
                body: formData
            });

            const data = await res.json();
            localStorage.setItem("analysisResults", JSON.stringify(data));

            try {
                const transformed = (function(predictResponse){
                    let counts = {};
                    if (predictResponse.species && Array.isArray(predictResponse.species)){
                        predictResponse.species.forEach(sp => { counts[sp.name] = sp.count; });
                    } else if (predictResponse.counts){
                        counts = predictResponse.counts;
                    }
                    const perClass = Object.entries(counts).map(([name,count])=>({class_name:name,count:count,percentage: predictResponse.total_count>0?((count/predictResponse.total_count)*100).toFixed(1):0}));
                    let verdict = 'Safe', reason = 'No harmful organisms detected.';
                    const unsafeClasses = ['rotifer']; const cautionClasses = ['algae'];
                    for (let cname in counts){ if (unsafeClasses.includes(cname.toLowerCase())){ verdict='Unsafe'; reason=`High-risk organism(s) detected: ${cname}. Immediate action recommended.`; break;} else if (cautionClasses.includes(cname.toLowerCase())){ if (verdict!=='Unsafe'){ verdict='Caution'; reason=`Presence of ${cname} detected. Review recommended.`; } } }
                    return {
                        total_detections: predictResponse.total_count||0,
                        per_class: perClass,
                        overall_verdict:{verdict:verdict,reason:reason},
                        annotated_image_url: predictResponse.annotated_image_url||'',
                        timestamp: predictResponse.timestamp||new Date().toISOString(),
                        analysis_id: predictResponse.analysis_id||predictResponse.id||0,
                        total_count: predictResponse.total_count||0,
                        species: predictResponse.species||[],
                        counts: counts,
                        detections: predictResponse.detections||[],
                        uploaded_image_url: predictResponse.uploaded_image_url||''
                    };
                })(data);
                localStorage.setItem('currentAnalysis', JSON.stringify(transformed));
            } catch(e){
                console.warn('Transform failed', e);
            }

            // navigate to analytics (same behavior as before)
            window.location.href = 'analytics.html';
        } catch (err){
            alert('Upload failed: '+err.message);
        }
    }

    // New wrapper: show modal first, run original handler, then hide modal
    analyzeBtn.addEventListener("click", async () => {
        try{
            if (typeof showProcessingModal === 'function') showProcessingModal();
        } catch(e){}
        try{
            await originalAnalyzeHandler();
        } finally {
            try{ if (typeof hideProcessingModal === 'function') hideProcessingModal(); } catch(e){}
        }
    });
    </script>

</body>
</html>